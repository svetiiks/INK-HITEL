<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Manager ‚Äî Rooms & Cleaning</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 20px;
      font-size: 16px;
      background: #ddd;
      border: none;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
    }
    .tab-btn.active {
      background: #2c3e50;
      color: white;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .tab-content.active {
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã –Ω–æ–º–µ—Ä–æ–≤ */
    .room-map .info {
      margin-bottom: 20px;
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-align: center;
    }
    .floor {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 6px;
    }
    .room {
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      color: white;
      border: 2px solid #444;
      border-radius: 3px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s;
    }
    .room:hover {
      transform: scale(1.1);
    }
    .free { background-color: #4CAF50; }
    .occupied { background-color: #F44336; }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É–±–æ—Ä–∫–∏ */
    .cleaning .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      margin-top: 0;
      color: #2c3e50;
      text-align: center;
    }
    .date-display {
      text-align: center;
      color: #666;
      font-style: italic;
      margin-bottom: 15px;
    }
    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #ecf0f1;
    }
    .room-select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
    }
    button:hover:not(:disabled) {
      background: #219653;
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .modal-buttons {
      margin-top: 20px;
    }
    .modal-buttons button {
      display: inline-block;
      width: 48%;
      margin: 0 1%;
    }
  </style>
</head>
<body>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="map">–ö–∞—Ä—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤</button>
    <button class="tab-btn" data-tab="cleaning">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–±–æ—Ä–∫–∏</button>
  </div>

  <!-- –ö–∞—Ä—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤ -->
  <div id="map" class="tab-content room-map active">
    <div class="info">üü¢ Green ‚Äî free | üî¥ Red ‚Äî occupied</div>
    <div class="floor" id="floor10"></div>
    <div class="floor" id="floor20"></div>
    <div class="floor" id="floor30"></div>
    <div class="floor" id="floor40"></div>
    <div class="floor" id="floor50"></div>
    <div class="floor" id="floor60"></div>
  </div>

  <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–±–æ—Ä–∫–∏ -->
  <div id="cleaning" class="tab-content cleaning">
    <div class="container" id="mainContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <!-- Modal –¥–ª—è PDF -->
  <div id="pdfModal" class="modal">
    <div class="modal-content">
      <h3>Save Report?</h3>
      <p>Work completed. Save PDF report?</p>
      <div class="modal-buttons">
        <button id="pdfYes">Yes</button>
        <button id="pdfNo">No</button>
      </div>
    </div>
  </div>

  <script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===
    const API_URL = "https://script.google.com/macros/s/AKfycbwwJN6L67adYokPcZBTovg4algSbXO_LSxgujTJbMWdYqUspCFgLSEN-dDbXfuGpsr1/exec";

    // === –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
    async function loadRoomStatesFromServer() {
      try {
        const res = await fetch(API_URL + '?action=getRooms');
        if (!res.ok) throw new Error("Network error: " + res.status);
        const data = await res.json();
        return data || {};
      } catch (e) {
        console.error("Failed to load room states:", e);
        return {};
      }
    }

    async function saveRoomStatesToServer(states) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'setRooms', rooms: states })
        });
        if (!res.ok) throw new Error("Save failed: " + res.status);
      } catch (e) {
        console.error("Failed to save room states:", e);
        alert("‚ö†Ô∏è Sync failed! Changes may not appear on other devices.");
      }
    }

    // === –í–ö–õ–ê–î–ö–ò ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        // –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π
        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');
      });
    });

    // === –ö–ê–†–¢–ê –ù–û–ú–ï–†–û–í ===
    const floors = [
      { id: 'floor10', rooms: Array.from({length: 10}, (_, i) => 10 + i) },
      { id: 'floor20', rooms: Array.from({length: 10}, (_, i) => 20 + i) },
      { id: 'floor30', rooms: Array.from({length: 10}, (_, i) => 30 + i) },
      { id: 'floor40', rooms: Array.from({length: 10}, (_, i) => 40 + i) },
      { id: 'floor50', rooms: Array.from({length: 10}, (_, i) => 50 + i) },
      { id: 'floor60', rooms: [60, 61] }
    ];

    async function createRooms() {
      const states = await loadRoomStatesFromServer();
      floors.forEach(floor => {
        const container = document.getElementById(floor.id);
        container.innerHTML = '';
        floor.rooms.forEach(roomNum => {
          const room = document.createElement('div');
          room.className = 'room';
          room.textContent = roomNum;
          room.dataset.room = roomNum;
          if (states[roomNum] === 'occupied') {
            room.classList.add('occupied');
          } else {
            room.classList.add('free');
          }
          room.addEventListener('click', async () => {
            room.classList.toggle('free');
            room.classList.toggle('occupied');
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            const currentStates = await loadRoomStatesFromServer();
            currentStates[roomNum] = room.classList.contains('occupied') ? 'occupied' : 'free';
            await saveRoomStatesToServer(currentStates);
          });
          container.appendChild(room);
        });
      });
    }

    // === –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–ë–û–†–ö–ò ===
    const ALL_ROOMS = [
      10,11,12,13,14,15,16,17,18,19,
      20,21,22,23,24,25,26,27,28,29,
      30,31,32,33,34,35,36,37,38,39,
      40,41,42,43,44,45,46,47,48,49,
      50,51,52,53,54,55,56,57,58,59,
      60,61
    ];

    let selectedRooms = new Set();
    let currentWorkerName = '';
    let currentTasks = [];
    const today = new Date().toLocaleDateString('en-GB');

    function createRoomSelect(currentValue = '') {
      const select = document.createElement('select');
      select.className = 'room-select';
      select.innerHTML = '<option value="">‚Äî</option>';
      ALL_ROOMS.forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        if (selectedRooms.has(room) && String(room) !== currentValue) {
          opt.disabled = true;
        }
        if (String(room) === currentValue) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });
      return select;
    }

    function updateRoomAvailability() {
      selectedRooms.clear();
      document.querySelectorAll('.room-select').forEach(sel => {
        if (sel.value) selectedRooms.add(Number(sel.value));
      });
      document.querySelectorAll('.room-select').forEach(sel => {
        const val = sel.value;
        const newSel = createRoomSelect(val);
        sel.replaceWith(newSel);
        newSel.addEventListener('change', updateRoomAvailability);
      });
    }

    function showInitialScreen() {
      const container = document.getElementById('mainContainer');
      container.innerHTML = `
        <h2>Worker Assignment</h2>
        <div class="date-display">Date: ${today}</div>
        <input type="text" id="workerName" placeholder="Enter worker name" maxlength="30">
        <h3>Assign Rooms</h3>
        <table id="assignmentTable">
          <thead><tr><th>Room</th><th>Checkout</th><th>Garim</th></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
        <button id="startBtn">Start</button>
      `;

      const tbody = document.getElementById('tableBody');
      for (let i = 0; i < 30; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td></td>
          <td><input type="checkbox" class="checkout"></td>
          <td><input type="checkbox" class="garim"></td>
        `;
        const select = createRoomSelect();
        row.cells[0].appendChild(select);
        tbody.appendChild(row);

        const co = row.querySelector('.checkout');
        const ga = row.querySelector('.garim');
        co.addEventListener('change', () => { if (co.checked) ga.checked = false; });
        ga.addEventListener('change', () => { if (ga.checked) co.checked = false; });
        select.addEventListener('change', updateRoomAvailability);
      }

      document.getElementById('startBtn').addEventListener('click', validateAndStart);
    }

    function showResultScreen(filledRows) {
      currentTasks = filledRows;
      const container = document.getElementById('mainContainer');
      let rowsHtml = '';
      filledRows.forEach(item => {
        rowsHtml += `
          <tr>
            <td>${item.room}</td>
            <td>${item.checkout ? '‚úÖ' : ''}</td>
            <td>${item.garim ? '‚úÖ' : ''}</td>
            <td><input type="checkbox" class="done-check"></td>
          </tr>
        `;
      });

      container.innerHTML = `
        <h2>Active Tasks for: ${currentWorkerName}</h2>
        <div class="date-display">Date: ${today}</div>
        <table>
          <thead><tr><th>Room</th><th>Checkout</th><th>Garim</th><th>Done</th></tr></thead>
          <tbody id="resultBody">${rowsHtml}</tbody>
        </table>
        <button id="finishBtn" style="display:none;">Finish Work</button>
      `;

      function checkFinish() {
        const allDone = Array.from(document.querySelectorAll('.done-check')).every(cb => cb.checked);
        document.getElementById('finishBtn').style.display = allDone ? 'block' : 'none';
      }

      document.getElementById('resultBody').addEventListener('change', (e) => {
        if (e.target.classList.contains('done-check')) checkFinish();
      });

      document.getElementById('finishBtn').addEventListener('click', () => {
        document.getElementById('pdfModal').style.display = 'block';
      });

      checkFinish();
    }

    function generateAndDownloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(18);
      doc.text('Hotel Work Report', 14, y);
      y += 12;
      doc.setFontSize(12);
      doc.text(`Worker: ${currentWorkerName}`, 14, y);
      y += 8;
      doc.text(`Date: ${today}`, 14, y);
      y += 12;
      doc.text('Completed Tasks (Status: Completed)', 14, y);
      y += 8;
      currentTasks.forEach(task => {
        const action = task.checkout ? 'Checkout' : 'Garim';
        const line = `Room ${task.room} ‚Äî Task: ${action}`;
        doc.text(line, 14, y);
        y += 7;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });
      const filename = `hotel-report-${currentWorkerName.replace(/\s+/g, '-')}-${today.replace(/\//g, '-')}.pdf`;
      doc.save(filename);
      showInitialScreen();
    }

    function validateAndStart() {
      const name = document.getElementById('workerName').value.trim();
      if (!name) { alert('Please enter worker name!'); return; }
      const filledRows = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const room = row.querySelector('.room-select').value;
        const co = row.querySelector('.checkout').checked;
        const ga = row.querySelector('.garim').checked;
        if (room && (co || ga)) filledRows.push({ room, checkout: co, garim: ga });
      });
      if (filledRows.length === 0) { alert('Please assign at least one room with a task!'); return; }
      currentWorkerName = name;
      showResultScreen(filledRows);
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ===
    document.getElementById('pdfYes').addEventListener('click', () => {
      document.getElementById('pdfModal').style.display = 'none';
      generateAndDownloadPDF();
    });
    document.getElementById('pdfNo').addEventListener('click', () => {
      document.getElementById('pdfModal').style.display = 'none';
      showInitialScreen();
    });

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    (async () => {
      await createRooms();
      if (typeof window.jspdf === 'undefined') {
        document.getElementById('mainContainer').innerHTML = `<h2>Error</h2><p>PDF library not loaded. Check internet.</p>`;
      } else {
        showInitialScreen();
      }
    })();
  </script>
</body>
</html>
